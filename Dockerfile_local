FROM alpine:3.22.2

ENV TZ=UTC \
    PYTHONUNBUFFERED=1

WORKDIR /app

# Install runtime dependencies and development tools
RUN apk add --no-cache python3 py3-pip tzdata

COPY requirements.txt docker-controller-bot.py config.py docker_update.py /app/

# Install application and development dependencies
RUN export PIP_BREAK_SYSTEM_PACKAGES=1 && \
    pip3 install --no-cache-dir -Ur /app/requirements.txt && \
    pip3 install --no-cache-dir debugpy watchdog[watchmedo]

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python3 -c "import sys; sys.exit(0)" || exit 1

# Use watchdog for file monitoring instead of nodemon
ENTRYPOINT ["watchmedo", "auto-restart", "-d", "/app", "-p", "*.py", "--", "python3", "docker-controller-bot.py"]